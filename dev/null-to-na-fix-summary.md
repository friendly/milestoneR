# Fix for NULL String Values in CSV Data

## Problem

Reference and milestone data contained the literal string "NULL" instead of proper NA values, causing ugly output in printed references.

**Example before fix:**
```
Buache, Phillippe. (1752). "Essai De Géographie Physique".
_Mémoires de L'Académie Royale des Sciences_. NULL(NULL). pp. 399-416.
```

The "NULL(NULL)" appeared because the volume and number fields contained the string "NULL" instead of NA.

## Root Cause

The CSV files (`data-raw/reference.csv` and `data-raw/milestone.csv`) contained the literal string "NULL" for missing values instead of empty fields.

**Example from reference.csv:**
```csv
546,article,"Buache, Phillippe",Essai De...,M&#233;moires..,,1752,NULL,NULL,399-416,NULL,NULL,NULL,,Buache:1752,,Loc{BNF...}
```

Fields with "NULL":
- volume: NULL
- number: NULL
- publisher: NULL
- address: NULL
- editor: NULL

## Solution

Added a conversion step to both data processing scripts to convert all "NULL" strings to NA immediately after reading the CSV files.

### Files Modified

#### 1. `data-raw/read_refs.R`

**Added:**
```r
# Convert all "NULL" strings to NA for consistency
reference <- reference |>
  mutate(across(everything(), ~ifelse(.x == "NULL", NA, .x)))
```

**Location:** Immediately after `read_csv("data-raw/reference.csv")`

**Effect:** Converts all "NULL" strings to proper NA values in all columns

#### 2. `data-raw/read-mstone.R`

**Added:**
```r
# Convert all "NULL" strings to NA for consistency
mstones <- mstones |>
  mutate(across(everything(), ~ifelse(.x == "NULL", NA, .x)))
```

**Location:** Immediately after `read_csv("data-raw/milestone.csv")`

**Effect:** Converts all "NULL" strings to proper NA values in all columns

### Data Files Regenerated

1. **`data/reference.RData`** - Regenerated by running `Rscript data-raw/read_refs.R`
2. **`data/milestone.RData`** - Regenerated by running `Rscript data-raw/read-mstone.R`

## Verification

### Reference Data

**Before fix:**
```r
load('data/reference.RData')
buache <- reference[reference$author == 'Buache, Phillippe' & reference$year == '1752', ]
buache$volume   # "NULL"
buache$number   # "NULL"
```

**After fix:**
```r
load('data/reference.RData')
buache <- reference[reference$author == 'Buache, Phillippe' & reference$year == '1752', ]
buache$volume   # NA
buache$number   # NA
```

### Statistics

**Reference table:**
- Total "NULL" strings before: 305
- Total "NULL" strings after: 0
- Fields now with NA values:
  - author: 6
  - journal: 218
  - month: 332
  - volume: 220
  - number: 305
  - pages: 200
  - publisher: 171
  - address: 180
  - editor: 341
  - booktitle: 172
  - abstract: 347
  - note: 256

**Milestone table:**
- Total "NULL" strings before: 2 (in `extra` field)
- Total "NULL" strings after: 0
- All `extra` field values now properly NA (297 records)

## Output Comparison

### Before Fix
```
Buache, Phillippe. (1752). "Essai De Géographie Physique".
_Mémoires de L'Académie Royale des Sciences_. NULL(NULL). pp. 399-416.
[Loc{BNF: Ge.FF-8816-8822}]
```

### After Fix
```
Buache, Phillippe. (1752). "Essai De Géographie Physique".
_Mémoires de L'Académie Royale des Sciences_. pp. 399-416.
[Loc{BNF: Ge.FF-8816-8822}]
```

The volume and number fields are now properly NA and don't appear in the formatted output.

## Testing

Tested with multiple print functions:

### print_reference()
```r
refs <- reference()
buache <- refs[refs$author == 'Buache, Phillippe' & refs$year == '1752', ]
print_reference(buache)
# Output: Buache, Phillippe. (1752). "Essai De Géographie Physique".
#         _Mémoires de L'Académie Royale des Sciences_. pp. 399-416.
#         [Loc{BNF: Ge.FF-8816-8822}]
```

### print_milestone_cli()
```r
print_milestone_cli(65)  # Milestone with Buache reference
# References section now displays correctly without NULL(NULL)
```

## Impact on Print Functions

The following functions now handle missing fields correctly:

1. **`print_reference()`** - Skips fields that are NA
2. **`print_milestone()`** - Skips NA fields in all formats (text, HTML, markdown)
3. **`print_milestone_cli()`** - Properly handles NA fields with cli formatting
4. **`.format_text_reference()`** - Internal helper, skips NA fields
5. **`.format_html_reference()`** - Internal helper, skips NA fields
6. **`.format_markdown_reference()`** - Internal helper, skips NA fields
7. **`.format_cli_reference()`** - Internal helper, skips NA fields

All print functions check for NA before including fields:
```r
if (!is.na(ref$volume) && nchar(ref$volume) > 0) {
  parts <- c(parts, ref$volume)
}
```

## Package Status

After fix:
- ✅ `devtools::check()` passes with **0 errors, 0 warnings, 0 notes**
- ✅ All 305 "NULL" strings in reference.csv converted to NA
- ✅ All 2 "NULL" strings in milestone.csv converted to NA
- ✅ References print cleanly without "NULL(NULL)" artifacts
- ✅ All print functions handle NA values correctly

## Future Prevention

To prevent "NULL" strings from appearing in future data updates:

1. **CSV export:** Ensure database exports use empty strings or proper NULL handling
2. **Data validation:** Add a check in data processing scripts to warn if "NULL" strings are found
3. **Documentation:** Document that missing values should be empty, not "NULL"

## Example of Affected References

References with previously problematic NULL values (now fixed):

- Buache (1752) - volume, number were "NULL"
- Many journal articles missing volume/number information
- Books missing publisher/address information
- Various references with missing editor information

All now display correctly with proper NA handling.
